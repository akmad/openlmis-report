<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.3.1.final using JasperReports Library version 6.3.1  -->
<!-- 2017-05-19T16:33:04 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="adjustments_summary_district" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="802" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="548a4d5f-1cb0-4fa0-b5f9-40a07c579f42">
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w1" value="0"/>
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w2" value="1000"/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="Sample DB"/>
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageHeight" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.topMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.bottomMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.leftMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.rightMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnSpacing" value="pixel"/>
	<property name="com.jaspersoft.studio.property.dataset.dialog.DatasetDialog.sash.w1" value="677"/>
	<property name="com.jaspersoft.studio.property.dataset.dialog.DatasetDialog.sash.w2" value="313"/>
	<parameter name="period" class="java.lang.String">
		<property name="displayName" value="Period Name"/>
		<property name="selectExpression" value="/api/reports/processingPeriods"/>
		<property name="selectProperty" value="name"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="true"/>
	</parameter>
	<parameter name="district" class="java.lang.String">
		<property name="displayName" value="District"/>
		<property name="selectExpression" value="/api/reports/districts"/>
		<property name="selectProperty" value="name"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="false"/>
	</parameter>
	<parameter name="program" class="java.lang.String">
		<property name="displayName" value="Program Name"/>
		<property name="selectExpression" value="/api/reports/programs"/>
		<property name="selectProperty" value="name"/>
		<property name="displayProperty" value="name"/>
		<property name="required" value="true"/>
	</parameter>
	<parameter name="imagesDirectory" class="java.lang.String" isForPrompting="false"/>
	<queryString language="plsql">
		<![CDATA[WITH RECURSIVE findChildZones AS (
  SELECT * FROM referencedata.geographic_zones WHERE name = $P{district}
  UNION ALL
  SELECT referencedata.geographic_zones.* FROM referencedata.geographic_zones JOIN findChildZones ON findChildZones.id = referencedata.geographic_zones.parentId
), findPreviousPeriods AS (
	SELECT * FROM referencedata.processing_periods AS periods
	WHERE periods.startdate <= (SELECT startdate FROM referencedata.processing_periods WHERE name = $P{period})
	AND periods.processingscheduleid = (SELECT processingscheduleid FROM referencedata.processing_periods WHERE name = $P{period})
	ORDER BY startdate DESC
)

SELECT
	periods.name AS periodname,
	facilities.name AS facilityname,
	facilities.code AS facilitycode,
	productcategories.displayname AS productcategory,
	products.dispensingunit AS dispensingunit,
	products.fullproductname AS productname,
	products.code AS productcode,
  	CASE 
		WHEN periods.id IN (SELECT id FROM findPreviousPeriods LIMIT 1) THEN 1
		WHEN periods.id IN (SELECT id FROM findPreviousPeriods LIMIT 1 OFFSET 1) THEN 2
		WHEN periods.id IN (SELECT id FROM findPreviousPeriods LIMIT 1 OFFSET 2) THEN 3
	END AS periodnumber,
	lineitems.stockonhand AS stockonhand,
	lineitems.approvedquantity AS approvedquantity,
	lineitems.totalconsumedquantity AS consumedquantity
FROM
	requisition.requisition_line_items AS lineitems
	JOIN requisition.requisitions AS requisitions ON requisitions.id = lineitems.requisitionid
	JOIN referencedata.processing_periods AS periods ON periods.id = requisitions.processingperiodid
	JOIN referencedata.facilities AS facilities ON facilities.id = requisitions.facilityid
	JOIN referencedata.programs AS programs ON programs.id = requisitions.programid
	JOIN referencedata.orderables AS products ON products.id = lineitems.orderableid
	JOIN referencedata.program_orderables AS programproducts ON programproducts.orderableid = products.id
	JOIN referencedata.orderable_display_categories AS productcategories ON productcategories.id = programproducts.orderabledisplaycategoryid
	JOIN referencedata.geographic_zones AS zones ON zones.id = facilities.geographiczoneid
WHERE
	programs.name = $P{program}
	AND ($P{district} IS NULL OR zones.id IN (SELECT id FROM findChildZones))
	AND periods.id IN (SELECT id FROM findPreviousPeriods LIMIT 3)
	AND requisitions.status = ANY('{APPROVED,RELEASED}')
	AND facilities.active = TRUE]]>
	</queryString>
	<field name="periodname" class="java.lang.String"/>
	<field name="periodnumber" class="java.lang.Integer"/>
	<field name="facilitycode" class="java.lang.String"/>
	<field name="facilityname" class="java.lang.String"/>
	<field name="productcategory" class="java.lang.String"/>
	<field name="dispensingunit" class="java.lang.String"/>
	<field name="productname" class="java.lang.String"/>
	<field name="productcode" class="java.lang.String"/>
	<field name="consumedquantity" class="java.lang.Integer"/>
	<field name="stockonhand" class="java.lang.Integer"/>
	<field name="approvedquantity" class="java.lang.Integer"/>
	<variable name="Consumption Period 1" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 1 ? $F{consumedquantity} : null]]></variableExpression>
	</variable>
	<variable name="Consumption Period 2" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 2 ? $F{consumedquantity} : null]]></variableExpression>
	</variable>
	<variable name="Consumption Period 3" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 3 ? $F{consumedquantity} : null]]></variableExpression>
	</variable>
	<variable name="Consumption Period 1 Count" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 1 ? 1 : 0]]></variableExpression>
	</variable>
	<variable name="Consumption Period 2 Count" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 2 ? 1 : 0]]></variableExpression>
	</variable>
	<variable name="Consumption Period 3 Count" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 3 ? 1 : 0]]></variableExpression>
	</variable>
	<variable name="Total Consumption" class="java.lang.Integer" resetType="Group" resetGroup="Product Code" calculation="Sum">
		<variableExpression><![CDATA[$F{consumedquantity}]]></variableExpression>
	</variable>
	<variable name="Period 2 Name" class="java.lang.String">
		<variableExpression><![CDATA[$F{periodnumber} == 2 ? $F{periodname} : $V{Period 2 Name}]]></variableExpression>
	</variable>
	<variable name="Period 3 Name" class="java.lang.String">
		<variableExpression><![CDATA[$F{periodnumber} == 3 ? $F{periodname} : $V{Period 3 Name}]]></variableExpression>
	</variable>
	<variable name="Period 1 Closing Balance" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 1 ? $F{stockonhand} + $F{approvedquantity} : 0]]></variableExpression>
	</variable>
	<variable name="Period 2 Closing Balance" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 2 ? $F{stockonhand} + $F{approvedquantity} : 0]]></variableExpression>
	</variable>
	<variable name="Period 3 Closing Balance" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{periodnumber} == 3 ? $F{stockonhand} + $F{approvedquantity} : 0]]></variableExpression>
	</variable>
	<group name="Facility Code">
		<groupExpression><![CDATA[$F{facilitycode}]]></groupExpression>
		<groupHeader>
			<band height="20">
				<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				<rectangle>
					<reportElement x="0" y="0" width="800" height="20" backcolor="#C0C0C0" uuid="86b6a127-d143-49c9-9754-dcf9664f20a0"/>
					<graphicElement>
						<pen lineWidth="0.0"/>
					</graphicElement>
				</rectangle>
				<textField isBlankWhenNull="true">
					<reportElement x="50" y="0" width="220" height="20" uuid="6fbf4300-abb9-4d37-ab7b-c27278688eda"/>
					<textFieldExpression><![CDATA[$F{facilityname}]]></textFieldExpression>
				</textField>
				<textField isBlankWhenNull="true">
					<reportElement x="0" y="0" width="40" height="20" uuid="10ee90db-d197-45fc-a827-922fc941eef8"/>
					<textFieldExpression><![CDATA[$F{facilitycode}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
	</group>
	<group name="Product Category">
		<groupExpression><![CDATA[$F{productcategory}]]></groupExpression>
		<groupHeader>
			<band height="20">
				<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				<textField isBlankWhenNull="true">
					<reportElement x="100" y="0" width="350" height="20" uuid="5d95c411-8223-407c-8d54-204efccaeb40"/>
					<textFieldExpression><![CDATA[$F{productcategory}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
	</group>
	<group name="Product Code">
		<groupExpression><![CDATA[$F{productcode}]]></groupExpression>
		<groupFooter>
			<band height="20">
				<textField isBlankWhenNull="true">
					<reportElement x="280" y="0" width="170" height="20" uuid="ab1b8c7f-242a-46ae-9653-cde39128ce71"/>
					<textFieldExpression><![CDATA[$F{productname} != null ? $F{productname} + " " + $F{dispensingunit} : null]]></textFieldExpression>
				</textField>
				<textField isBlankWhenNull="true">
					<reportElement x="190" y="0" width="80" height="20" uuid="463ded2c-72f8-4378-ad69-f513ede91e9f"/>
					<textFieldExpression><![CDATA[$F{productcode}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="#,##0.###;(#,##0.###-)" isBlankWhenNull="true">
					<reportElement x="520" y="0" width="70" height="20" uuid="f875ee85-3b20-46fe-a422-7bb10d811e06">
						<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					</reportElement>
					<textElement textAlignment="Right"/>
					<textFieldExpression><![CDATA[$V{Consumption Period 1} / $V{Consumption Period 1 Count}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="#,##0.###;(#,##0.###-)" isBlankWhenNull="true">
					<reportElement x="600" y="0" width="70" height="20" uuid="fafcbb95-2fac-4ebd-bb63-0ce5135cad56">
						<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					</reportElement>
					<textElement textAlignment="Right"/>
					<textFieldExpression><![CDATA[$V{Consumption Period 2} / $V{Consumption Period 2 Count}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="#,##0.###;(#,##0.###-)" isBlankWhenNull="true">
					<reportElement x="685" y="0" width="70" height="20" uuid="e2739dbc-7a66-42b0-9a17-e7f8e4b93cb4">
						<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					</reportElement>
					<textElement textAlignment="Right"/>
					<textFieldExpression><![CDATA[$V{Consumption Period 3} / $V{Consumption Period 3 Count}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="#,##0.###;(#,##0.###-)" isBlankWhenNull="true">
					<reportElement x="760" y="0" width="40" height="20" uuid="f827ab65-0195-461a-9d5c-ae6ecad6df26">
						<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
						<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					</reportElement>
					<textElement textAlignment="Right"/>
					<textFieldExpression><![CDATA[$V{Total Consumption} / $V{Product Code_COUNT}]]></textFieldExpression>
				</textField>
				<textField isStretchWithOverflow="true" pattern="#,##0.###;(#,##0.###-)" isBlankWhenNull="true">
					<reportElement x="460" y="0" width="60" height="20" uuid="41ea6fb2-2b00-4e84-8ffb-e89185f96a9d"/>
					<textElement textAlignment="Left"/>
					<textFieldExpression><![CDATA[$V{Consumption Period 1 Count} > 0 ? $V{Period 1 Closing Balance}
	: $V{Consumption Period 2 Count} > 0 ? $V{Period 2 Closing Balance}
		: $V{Consumption Period 3 Count} > 0 ? $V{Period 3 Closing Balance}
			: 0]]></textFieldExpression>
				</textField>
			</band>
		</groupFooter>
	</group>
	<group name="Period Name">
		<groupExpression><![CDATA[$F{periodname}]]></groupExpression>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<pageHeader>
		<band height="130" splitType="Stretch">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<textField>
				<reportElement key="" x="640" y="100" width="160" height="20" uuid="eecc1140-a4a9-4bd6-9d4e-4828b52367fe">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Left"/>
				<textFieldExpression><![CDATA[new SimpleDateFormat("d - MMM - yy").format(new java.util.Date())]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="420" y="100" width="220" height="20" uuid="b9f82e73-78bb-40d2-ba66-fd3608a549e4"/>
				<textFieldExpression><![CDATA[$P{period}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="0" y="100" width="200" height="20" uuid="ef0b0cb1-79c4-4f50-96c2-374e38663441"/>
				<textFieldExpression><![CDATA[($P{district} == null) ? "All" : $P{district}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="0" y="80" width="200" height="20" uuid="b7eb243f-bfd2-4c2b-9d4b-55a96d943688"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[District:]]></text>
			</staticText>
			<staticText>
				<reportElement x="420" y="80" width="220" height="20" uuid="49396b21-8814-4680-8783-0f1a5a5bfea0"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="10" isBold="true"/>
				</textElement>
				<text><![CDATA[Reporting Period:]]></text>
			</staticText>
			<staticText>
				<reportElement key="" x="640" y="80" width="160" height="20" uuid="1f3fbbaa-0915-4a25-90ab-f5d72944ebe4">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Left" verticalAlignment="Middle" markup="none">
					<font size="10" isBold="true"/>
				</textElement>
				<text><![CDATA[Report Run Date:]]></text>
			</staticText>
			<textField>
				<reportElement x="200" y="100" width="220" height="20" uuid="6218362b-b764-454e-ac91-26df903c0c8c"/>
				<textFieldExpression><![CDATA[$P{program}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="200" y="80" width="220" height="20" uuid="96e25b35-81c2-417a-a700-b8d7107a533c"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Program:]]></text>
			</staticText>
			<staticText>
				<reportElement x="240" y="0" width="280" height="39" uuid="af8e209d-cf2a-49a1-8c8a-6213dca400ea">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="18"/>
				</textElement>
				<text><![CDATA[Ministry of Health, Malawi]]></text>
			</staticText>
			<textField>
				<reportElement x="680" y="0" width="80" height="20" uuid="d2a693cf-48f0-4536-bd99-e9d7a04012a8"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression><![CDATA["Page " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="760" y="0" width="40" height="20" uuid="056de5f4-5e79-4053-97cd-0c52ec9883cf"/>
				<textElement textAlignment="Left"/>
				<textFieldExpression><![CDATA[" of " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<image>
				<reportElement x="0" y="0" width="50" height="50" uuid="e916dce2-a090-4a92-83ae-9c46792bcf61"/>
				<imageExpression><![CDATA[getClass().getResourceAsStream($P{imagesDirectory} + "malawi_crest.png")]]></imageExpression>
			</image>
			<textField>
				<reportElement mode="Opaque" x="0" y="60" width="800" height="20" forecolor="#FFFFFF" backcolor="#787878" uuid="32ea78b5-e1df-411f-9fab-df6c8237d654"/>
				<textElement textAlignment="Center">
					<font size="15" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$P{program} + " Distribution List"]]></textFieldExpression>
			</textField>
		</band>
	</pageHeader>
	<columnHeader>
		<band height="30">
			<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
			<staticText>
				<reportElement x="200" y="0" width="70" height="30" uuid="5700da4a-3546-46d9-8b06-8c9974587906">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[Product Code]]></text>
			</staticText>
			<staticText>
				<reportElement x="280" y="0" width="170" height="30" uuid="28218e91-dd35-44cd-85e4-c741b496f2fe">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[Product Name]]></text>
			</staticText>
			<staticText>
				<reportElement x="100" y="0" width="90" height="30" uuid="484a5752-98b8-4219-87e0-a0ee74aff442">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.y" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[Product Category]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="0" width="90" height="30" uuid="b49b5147-0c7f-4271-8769-416792800f0b"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[Facility]]></text>
			</staticText>
			<staticText>
				<reportElement x="460" y="0" width="50" height="30" uuid="4705ff38-5302-46e8-b1fe-9aa7990fc521">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.y" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[Closing Balance]]></text>
			</staticText>
			<textField>
				<reportElement x="520" y="0" width="70" height="30" uuid="4019c051-1fde-4411-8bea-ed5a47ccfb2a">
					<property name="com.jaspersoft.studio.unit.y" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA["Consumption " + $P{period}]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="600" y="0" width="70" height="30" uuid="7220fc53-38f3-4d9b-9424-4e0417128026">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$V{Period 2 Name} != null ? "Consumption " + $V{Period 2 Name} : null]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report" isBlankWhenNull="true">
				<reportElement x="680" y="0" width="70" height="30" uuid="62c5f2a2-c35d-4cb6-abd7-fc9db6c79726">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$V{Period 3 Name} != null ? "Consumption " + $V{Period 3 Name} : null]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="760" y="0" width="40" height="30" uuid="84c81102-22e6-44b0-b059-5c1ef67519b1"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<text><![CDATA[AMC]]></text>
			</staticText>
		</band>
	</columnHeader>
</jasperReport>
